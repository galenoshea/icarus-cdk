# MCP Architecture

Understanding how Icarus canisters integrate with MCP (Model Context Protocol) clients.

## Overview

Icarus canisters are designed to natively support MCP protocol, enabling direct communication with Claude Desktop and other MCP clients. The integration is handled through built-in MCP commands that manage the connection between clients and deployed canisters.

## Architecture Diagram

```
┌─────────────────┐         ┌──────────────────┐         ┌─────────────────┐
│ Claude Desktop  │ ──────> │  MCP Commands    │ ──────> │  ICP Canister   │
│  (MCP Client)   │ <────── │  (CLI Integration)│ <────── │ (MCP Server)    │
└─────────────────┘         └──────────────────┘         └─────────────────┘
     JSON-RPC                  icarus mcp start              Native MCP
    over stdio                CLI Management               Built-in Support
```

## Key Design Principles

### 1. Native MCP Integration
- Canisters have built-in MCP protocol support
- Direct communication without intermediate translation layers
- Canisters expose both Candid and MCP interfaces

### 2. CLI-Managed Connections
- `icarus mcp` commands handle client registration
- Automatic configuration of Claude Desktop and other MCP clients
- Centralized connection management

### 3. Dynamic Tool Discovery
- Canisters automatically expose their tools via MCP
- Tools are discovered through the `get_tools()` query function
- Real-time updates when canister tools change

## How It Works

### 1. MCP Setup

When you run `icarus mcp add --canister-id <id>`:

```rust
// MCP integration sequence
1. Parse command line arguments
2. Detect installed MCP clients (Claude Desktop, etc.)
3. Query canister's get_tools() function
4. Generate MCP server configuration
5. Update client configuration files
6. Register canister as available MCP server
```

### 2. Tool Discovery

MCP clients discover tools directly from canisters:

```rust
// MCP clients query canister directly
let tools_response = canister.query("get_tools", ()).await?;
let tools_json: String = decode_one(&tools_response)?;

// Tools are automatically available in MCP format
// No translation layer needed
let mcp_tools: Vec<McpTool> = serde_json::from_str(&tools_json)?;
```

### 3. Direct Communication

#### MCP Protocol

MCP clients communicate directly with canisters using the MCP protocol:

```json
// MCP Request to Canister
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "memorize",
    "arguments": {
      "content": "Hello world",
      "tags": ["greeting"]
    }
  },
  "id": 1
}
```

#### Native MCP Response

Canisters respond directly in MCP format:

```json
// Direct MCP Response
{
  "jsonrpc": "2.0",
  "result": {
    "content": [
      {
        "type": "text",
        "text": "Memory stored with ID: mem_123"
      }
    ]
  },
  "id": 1
}
```

## Implementation Details

### MCP Integration Components

#### 1. CLI Commands
The `icarus mcp` commands manage MCP client integration:

```rust
// Available MCP commands
icarus mcp add --canister-id <id>     // Add canister to MCP clients
icarus mcp list                       // List registered canisters
icarus mcp remove --canister-id <id>  // Remove canister
icarus mcp status                     // Check connection status
```

#### 2. Client Configuration
Automatically configures MCP clients:

```json
// Claude Desktop configuration (auto-generated)
{
  "mcpServers": {
    "icarus-canister-rdmx6": {
      "command": "icarus",
      "args": ["mcp", "start", "--canister-id", "rdmx6-jaaaa-aaaah-qacbq-cai"],
      "env": {
        "DFX_NETWORK": "ic"
      }
    }
  }
}
```

#### 3. Canister Integration
Canisters include built-in MCP support:

```rust
// Generated by #[icarus::mcp] macro
#[ic_cdk::query]
pub fn get_tools() -> String {
    // Returns MCP-compatible tool definitions
    serde_json::to_string(&get_available_tools()).unwrap()
}

#[ic_cdk::update]
pub fn mcp_call_tool(request: String) -> String {
    // Handles MCP tool calls directly
    handle_mcp_request(&request)
}
```

1. **Simplified Architecture**: No intermediate translation layer
2. **Native Performance**: Direct MCP protocol support
3. **Easier Maintenance**: Built-in MCP support in canisters
4. **Better Reliability**: Fewer moving parts and failure points

## Getting Started

To integrate your canister with MCP clients:

1. Build your canister with MCP support:
   ```bash
   icarus build
   ```

2. Deploy to the Internet Computer:
   ```bash
   icarus deploy
   ```

3. Add to MCP clients:
   ```bash
   icarus mcp add --canister-id your-canister-id
   ```

4. Start using in Claude Desktop or other MCP clients!

For more details, see the [MCP Client Management Guide](./MCP_CLIENT_MANAGEMENT.md).