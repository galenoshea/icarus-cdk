# Cargo Release Configuration
# This file configures cargo-release to automatically update version strings
# across all project files from a single source of truth

# Don't automatically push (we'll do it manually after verification)
push = false
publish = false

# Shared version across workspace
shared-version = true

# Consolidate all version bumps into a single commit
consolidate-commits = true

# Commit settings
pre-release-commit-message = "chore: release version {{version}}"
tag-message = "Release version {{version}}"
tag-name = "v{{version}}"

# Sign commits and tags if GPG is configured
sign-commit = false
sign-tag = false

# CRITICAL: Update [dependencies] section versions in root Cargo.toml
# These are often missed by cargo-release and cause CI failures
[[pre-release-replacements]]
file = "Cargo.toml"
search = 'icarus-core = \{ version = "[0-9]+\.[0-9]+\.[0-9]+"'
replace = 'icarus-core = { version = "{{version}}"'
exactly = 2  # Should appear in both [dependencies] and [workspace.dependencies]

[[pre-release-replacements]]
file = "Cargo.toml"
search = 'icarus-derive = \{ version = "[0-9]+\.[0-9]+\.[0-9]+"'
replace = 'icarus-derive = { version = "{{version}}"'
exactly = 2  # Should appear in both [dependencies] and [workspace.dependencies]

[[pre-release-replacements]]
file = "Cargo.toml"
search = 'icarus-canister = \{ version = "[0-9]+\.[0-9]+\.[0-9]+"'
replace = 'icarus-canister = { version = "{{version}}"'
exactly = 2  # Should appear in both [dependencies] and [workspace.dependencies]

# Replacements for version strings in documentation
[[pre-release-replacements]]
file = "README.md"
search = 'icarus = "[0-9]+\.[0-9]+\.[0-9]+"'
replace = 'icarus = "{{version}}"'
min = 1

[[pre-release-replacements]]
file = "README.md"
search = 'icarus-canister = "[0-9]+\.[0-9]+\.[0-9]+"'
replace = 'icarus-canister = "{{version}}"'
min = 0

[[pre-release-replacements]]
file = "README.md"
search = 'cargo install icarus-cli@[0-9]+\.[0-9]+\.[0-9]+'
replace = 'cargo install icarus-cli@{{version}}'
min = 0

[[pre-release-replacements]]
file = "README.md"
search = 'icarus-core = "[0-9]+\.[0-9]+\.[0-9]+"'
replace = 'icarus-core = "{{version}}"'
min = 0

[[pre-release-replacements]]
file = "README.md"
search = 'icarus-derive = "[0-9]+\.[0-9]+\.[0-9]+"'
replace = 'icarus-derive = "{{version}}"'
min = 0

# Update version notices in README if present
[[pre-release-replacements]]
file = "README.md"
search = 'Version [0-9]+\.[0-9]+\.[0-9]+\+'
replace = 'Version {{version}}+'
min = 0

# Update version in docs README
[[pre-release-replacements]]
file = "docs/README.md"
search = 'Version [0-9]+\.[0-9]+\.[0-9]+'
replace = 'Version {{version}}'
min = 0

# Update current version in migration guide
[[pre-release-replacements]]
file = "docs/migration-guide.md"
search = 'Current Version \([0-9]+\.[0-9]+\.[0-9]+\)'
replace = 'Current Version ({{version}})'
min = 0


# Update any version references in migration guide headers
[[pre-release-replacements]]
file = "docs/migration-guide.md"
search = 'Version [0-9]+\.[0-9]+\.[0-9]+ is'
replace = 'Version {{version}} is'
min = 0

# Update version examples in migration guide
[[pre-release-replacements]]
file = "docs/migration-guide.md"
search = 'use version [0-9]+\.[0-9]+\.[0-9]+:'
replace = 'use version {{version}}:'
min = 0

# Update all workspace crate version references in migration guide
[[pre-release-replacements]]
file = "docs/migration-guide.md"
search = 'same version number \([0-9]+\.[0-9]+\.[0-9]+\)'
replace = 'same version number ({{version}})'
min = 0